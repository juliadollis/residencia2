cd ~/rag_mm
source .venv/bin/activate
unset HF_HUB_ENABLE_HF_TRANSFER || true
export HF_HUB_ENABLE_HF_TRANSFER=0

cat > src/query_retrieve.py << 'PY'
import json, os, numpy as np, torch
from datasets import load_dataset
from transformers import CLIPModel, CLIPProcessor
from PIL import Image

def save_images(ds, idxs, img_col, out_dir):
    os.makedirs(out_dir, exist_ok=True)
    paths=[]
    for r,i in enumerate(idxs,start=1):
        row=ds[int(i)]
        im=row[img_col]
        im=im if isinstance(im,Image.Image) else Image.open(im)
        p=os.path.join(out_dir,f"hit_{r:02d}.jpg")
        im.save(p,"JPEG",quality=90)
        paths.append(p)
    return paths

def main():
    cfg=json.load(open("config.json"))
    info=json.load(open(os.path.join(cfg["index_dir"],"index_info.json")))
    dname=info["dataset_name"]
    used_split=info["used_split"]
    img_col=info["image_column"]
    txt_col=info["text_column"]
    model_name=info["model_name"]
    top_k=int(cfg["top_k"])
    feats=np.load(os.path.join(cfg["index_dir"],"image_embeds.npy"))
    meta=[json.loads(x) for x in open(os.path.join(cfg["index_dir"],"meta.jsonl"),encoding="utf-8")]
    ds=load_dataset(dname,split=used_split)
    device="cuda" if torch.cuda.is_available() else "cpu"
    model=CLIPModel.from_pretrained(model_name).to(device).eval()
    proc=CLIPProcessor.from_pretrained(model_name)
    import sys
    query=" ".join(sys.argv[1:]) if len(sys.argv)>1 else "how were the paints of Claude Monet during Post-Impressionism"
    idxs=np.arange(len(meta))
    feats_m=feats
    with torch.no_grad():
        enc=proc(text=[query],return_tensors="pt").to(device)
        qf=model.get_text_features(**enc)
        qf=torch.nn.functional.normalize(qf,dim=-1).cpu().numpy()[0]
    sims=feats_m@qf
    order=np.argsort(-sims)[:top_k]
    hits=idxs[order]
    paths=save_images(ds,hits,img_col,cfg["retrieved_dir"])
    os.makedirs(os.path.dirname(cfg["results_jsonl"]),exist_ok=True)
    with open(cfg["results_jsonl"],"w",encoding="utf-8") as f:
        for r,(i,p) in enumerate(zip(hits,paths),start=1):
            m=meta[int(i)]
            f.write(json.dumps({"rank":r,"score":float(sims[order[r-1]]),"index":int(i),"image_path":p,"style":m.get("style",""),"caption":m.get("caption","")},ensure_ascii=False)+"\n")
    print("Query:",query)
    for r,(i,p) in enumerate(zip(hits,paths),start=1):
        m=meta[int(i)]
        print(f"{r}\t{sims[order[r-1]]:.4f}\t{p}\t{m.get('style','')}\t{m.get('caption','')[:140]}")

if __name__=="__main__":
    main()
PY

cat > src/query_compare.py << 'PY'
import json, os, numpy as np, torch
from datasets import load_dataset
from transformers import CLIPModel, CLIPProcessor
from PIL import Image

def save_images(ds, idxs, img_col, out_dir):
    os.makedirs(out_dir,exist_ok=True)
    paths=[]
    for r,i in enumerate(idxs,start=1):
        row=ds[int(i)]
        im=row[img_col]
        im=im if isinstance(im,Image.Image) else Image.open(im)
        p=os.path.join(out_dir,f"hit_{r:02d}.jpg")
        im.save(p,"JPEG",quality=90)
        paths.append(p)
    return paths

def run_model(query, cfg, info, meta, ds, model_id, name):
    img_col=info["image_column"]
    top_k=int(cfg["top_k"])
    root=cfg["index_root"]
    feats=np.load(os.path.join(root,name,"image_embeds.npy"))
    idxs=np.arange(len(meta))
    feats_m=feats
    device="cuda" if torch.cuda.is_available() else "cpu"
    model=CLIPModel.from_pretrained(model_id).to(device).eval()
    proc=CLIPProcessor.from_pretrained(model_id)
    with torch.no_grad():
        enc=proc(text=[query],return_tensors="pt").to(device)
        qf=model.get_text_features(**enc)
        qf=torch.nn.functional.normalize(qf,dim=-1).cpu().numpy()[0]
    sims=feats_m@qf
    order=np.argsort(-sims)[:top_k]
    hits=idxs[order]
    out_root=cfg["outputs_root"]
    out_dir=os.path.join(out_root,"retrieved",name)
    paths=save_images(ds,hits,img_col,out_dir)
    res_path=os.path.join(out_root,f"{name}_retrieval.jsonl")
    os.makedirs(out_root,exist_ok=True)
    with open(res_path,"w",encoding="utf-8") as f:
        for r,(i,p) in enumerate(zip(hits,paths),start=1):
            m=meta[int(i)]
            f.write(json.dumps({"model":name,"rank":r,"score":float(sims[order[r-1]]),"index":int(i),"image_path":p,"style":m.get("style",""),"caption":m.get("caption","")},ensure_ascii=False)+"\n")
    return [{"model":name,"rank":int(r+1),"score":float(sims[order[r]]),"index":int(hits[r]),"image_path":paths[r],"style":meta[int(hits[r])].get("style",""),"caption":meta[int(hits[r])].get("caption","")} for r in range(len(hits))]

def main():
    cfg=json.load(open("config_multi.json"))
    info=json.load(open(os.path.join(cfg["index_root"],"index_info.json")))
    ds=load_dataset(info["dataset_name"],split=info["used_split"])
    meta=[json.loads(x) for x in open(os.path.join(cfg["index_root"],"meta.jsonl"),encoding="utf-8")]
    import sys
    query=" ".join(sys.argv[1:]) if len(sys.argv)>1 else "how were the paints of Claude Monet during Post-Impressionism"
    all_rows=[]
    for m in cfg["models"]:
        rows=run_model(query,cfg,info,meta,ds,m["id"],m["name"])
        all_rows.extend(rows)
    cmp_path=os.path.join(cfg["outputs_root"],"compare_topk.tsv")
    with open(cmp_path,"w",encoding="utf-8") as f:
        f.write("model\trank\tscore\tindex\timage_path\tstyle\tcaption\n")
        for r in all_rows:
            f.write(f"{r['model']}\t{r['rank']}\t{r['score']:.6f}\t{r['index']}\t{r['image_path']}\t{r['style']}\t{r['caption'].replace(chr(9),' ').replace(chr(10),' ')[:300]}\n")
    print("Query:",query)
    for m in cfg["models"]:
        subset=[x for x in all_rows if x["model"]==m["name"]]
        print(m["name"])
        for r in subset[:cfg["top_k"]]:
            print(f"{r['rank']}\t{r['score']:.4f}\t{r['image_path']}\t{r['style']}\t{r['caption'][:140]}")

if __name__=="__main__":
    main()
PY

python -m src.query_compare "how were the paints of Claude Monet during Post-Impressionism"
python -m src.query_retrieve "how were the paints of Claude Monet during Post-Impressionism"



PARA ALTERAR O NOME DO MODELO ALTERE EM
nano /workspace/aplicacao/rag/config_multi.json


"models": [
  {"id": "openai/clip-vit-base-patch32", "name": "clip_base"},
  {"id": "turing552/clip-wikiart-raw-v1-10ep", "name": "clip_wikiart_raw"}
],


cd /workspace/aplicacao/rag
source .venv/bin/activate
python -m src.build_index_multi
python -m src.query_compare "how were the paints of Claude Monet during Post-Impressionism"
